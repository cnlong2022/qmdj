
/**
 * 农历核心服务 - 严格遵循 ASP 源码逻辑
 * 数据范围：1921 - 2050
 */
const NONGLI_DATA: Record<number, number> = {
  1921: 2635, 1922: 333387, 1923: 1701, 1924: 1748, 1925: 267701, 1926: 694, 1927: 2391, 1928: 133423, 1929: 1175, 1930: 396438,
  1931: 3402, 1932: 3749, 1933: 331177, 1934: 1453, 1935: 694, 1936: 201326, 1937: 2350, 1938: 465197, 1939: 3221, 1940: 3402,
  1941: 400202, 1942: 2901, 1943: 1386, 1944: 267611, 1945: 605, 1946: 2349, 1947: 137515, 1948: 2709, 1949: 464533, 1950: 1738,
  1951: 2901, 1952: 330421, 1953: 1242, 1954: 2651, 1955: 199255, 1956: 1323, 1957: 529706, 1958: 3733, 1959: 1706, 1960: 398762,
  1961: 2741, 1962: 1206, 1963: 267438, 1964: 2647, 1965: 1318, 1966: 204070, 1967: 3477, 1968: 461653, 1969: 1386, 1970: 2413,
  1971: 330077, 1972: 1197, 1973: 2637, 1974: 268877, 1975: 3365, 1976: 531109, 1977: 2900, 1978: 2922, 1979: 398042, 1980: 2395,
  1981: 1179, 1982: 267415, 1983: 2635, 1984: 661067, 1985: 1701, 1986: 1748, 1987: 398772, 1988: 2742, 1989: 2391, 1990: 330031,
  1991: 1175, 1992: 1611, 1993: 200010, 1994: 3749, 1995: 527717, 1996: 1452, 1997: 2742, 1998: 332397, 1999: 2350, 2000: 3222,
  2001: 268949, 2002: 3402, 2003: 3493, 2004: 133973, 2005: 1386, 2006: 464219, 2007: 605, 2008: 2349, 2009: 334123, 2010: 2709,
  2011: 2890, 2012: 267946, 2013: 2773, 2014: 592565, 2015: 1210, 2016: 2651, 2017: 395863, 2018: 1323, 2019: 2707, 2020: 265877,
  // 修正后的 2021-2050 数据
  2021: 1706, 2022: 2773, 2023: 133557, 2024: 1206, 2025: 398510, 2026: 2638, 2027: 3366, 2028: 335142, 2029: 3411, 2030: 1450,
  2031: 200042, 2032: 2413, 2033: 723293, 2034: 1197, 2035: 2637, 2036: 399947, 2037: 3365, 2038: 3410, 2039: 334676, 2040: 2906,
  2041: 37728, 2042: 51936, 2043: 51552, 2044: 54432, 2045: 55888, 2046: 30048, 2047: 22176, 2048: 43952, 2049: 9680, 2050: 37600
};

// 1921年2月8日正月初一 (UTC+8)
const BASE_DATE = new Date('1921-02-08T00:00:00+08:00');

const LUNAR_MONTH_NAMES = ["*", "正", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一", "腊"];
const LUNAR_DAY_NAMES = [
  "*", "初一", "初二", "初三", "初四", "初五", "初六", "初七", "初八", "初九", "初十",
  "十一", "十二", "十三", "十四", "十五", "十六", "十七", "十八", "十九", "二十",
  "廿一", "廿二", "廿三", "廿四", "廿五", "廿六", "廿七", "廿八", "廿九", "三十"
];

/**
 * 将公历日期转换为农历日期
 * 严格对齐 ASP 的算法逻辑
 */
export function toLunar(date: Date): string {
  // 计算到 1921-02-08 的天数差
  // 使用 UTC 偏移量确保不受本地时区跨天干扰
  const msPerDay = 86400000;
  let offset = Math.floor((date.getTime() - BASE_DATE.getTime()) / msPerDay);
  
  if (offset < 0) return "日期超出范围";

  let m = 0; // 对应 ASP 的 m (年份索引)
  let k = 0; // 总月份数 (11或12)
  let n = 0; // 当前处理的位索引
  let isEnd = false;
  let bit = 0;

  // 1. 寻找年份 (对应 ASP 的 Do Loop m)
  while (m <= 129) { // 1921 到 2050 约 130 年
    const yearData = NONGLI_DATA[1921 + m];
    if (!yearData) break;

    k = yearData < 4095 ? 11 : 12; // ASP: If (NongliData(m) < 4095) Then k = 11 Else k = 12
    n = k;

    // 2. 寻找月份 (对应 ASP 的 Do Loop n)
    while (n >= 0) {
      // 获取第 n 个二进制位的值 (ASP: bit = Int(bit / 2) ... bit = bit Mod 2)
      bit = (yearData >> n) & 0x1;
      
      const monthDays = 29 + bit;
      if (offset < monthDays) {
        isEnd = true;
        break;
      }
      
      offset -= monthDays;
      n--;
    }

    if (isEnd) break;
    m++;
  }

  const curYear = 1921 + m;
  let curMonth = k - n + 1; // 对应 ASP 的 curMonth = k - n + 1
  const curDay = offset + 1; // 对应 ASP 的 curDay = TheDate (此时 offset 已减去之前月份)

  // 3. 处理闰月逻辑 (对应 ASP 的 If (k = 12) Then...)
  const yearData = NONGLI_DATA[curYear];
  if (k === 12) {
    const leapMonthIdx = Math.floor(yearData / 65536) + 1; // ASP: Int(NongliData(m) / 65536) + 1
    if (curMonth === leapMonthIdx) {
      curMonth = 1 - curMonth; // 闰月标记
    } else if (curMonth > leapMonthIdx) {
      curMonth = curMonth - 1;
    }
  }

  // 4. 格式化输出 (对应 ASP 的 NongliDayStr 逻辑)
  let result = "";
  if (curMonth < 1) {
    result = "闰" + LUNAR_MONTH_NAMES[Math.abs(curMonth)] + "月";
  } else {
    result = LUNAR_MONTH_NAMES[curMonth] + "月";
  }

  result += LUNAR_DAY_NAMES[curDay];
  
  // 兼容 ASP 中的特殊硬编码 (可选，但建议保留以完全对齐原逻辑)
  // 检查公历日期是否为 2004-04-29
  const dateStr = date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + date.getDate();
  if (dateStr === "2004-4-29") {
    return "三月十一";
  }

  return result;
}
